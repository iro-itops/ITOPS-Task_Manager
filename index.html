<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>ITOPS Task Manager</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<style>
  :root{
    --bg:#f5f6f8; --card:#ffffff; --muted:#6b7280; --accent:#50636d; --accent-2:#638188;
  }
  body { background:var(--bg); font-family: Inter, "Segoe UI", Roboto, Arial; margin:0; color:#1f2937; padding:18px; }
  .wrap{ max-width:1100px; margin:0 auto; }
  header{ display:flex; align-items:center; gap:12px; padding:14px 18px; background:var(--card); border-radius:10px; box-shadow:0 4px 16px rgba(16,24,40,0.06); margin-bottom:14px; }
  header h1{ margin:0; font-size:1.15rem; color:#0f172a; }
  header .sub{ color:var(--muted); font-size:0.9rem; margin-left:8px; }

  /* tabs */
  .tabs{ display:flex; gap:8px; margin:14px 0; flex-wrap:wrap; }
  .tab-btn{ padding:8px 12px; border-radius:10px; background:#e6eef0; color:#0f172a; border:none; cursor:pointer; font-weight:600; }
  .tab-btn.active{ background:var(--accent); color:#fff; box-shadow:0 6px 18px rgba(80,99,109,0.12); transform:translateY(-1px); }

  .card{ background:var(--card); border-radius:10px; padding:14px; box-shadow:0 4px 16px rgba(16,24,40,0.04); margin-bottom:14px; }

  /* DAILY tasks list */
  .task-card{ display:flex; gap:12px; align-items:flex-start; padding:10px; border-radius:8px; background:#fafafa; border:1px solid #eef2f6; margin-bottom:8px; }
  .task-left{ flex:1; }
  .task-name{ font-weight:700; margin-bottom:4px; }
  .task-desc{ color:var(--muted); font-size:0.88rem; margin-bottom:4px; }
  .task-right{ width:260px; display:flex; flex-direction:column; gap:6px; align-items:flex-end; }

  select, textarea, input[type=text] { padding:8px; border-radius:8px; border:1px solid #e6eef0; font-size:14px; width:100%; box-sizing:border-box; background:#fff; }

  .controls{ display:flex; gap:8px; margin-top:10px; }
  .btn{ padding:8px 12px; border-radius:8px; border:none; cursor:pointer; color:#fff; background:var(--accent-2); font-weight:700; }
  .btn.alt{ background:#e6eef0; color:#0f172a; font-weight:600; }
  .btn.warn{ background:#b03e3e; box-shadow:0 6px 18px rgba(176,62,62,0.12); }

  /* Monitoring grid */
  .monitor-grid{ display:grid; grid-template-columns: repeat(auto-fit,minmax(320px,1fr)); gap:12px; margin-top:10px; }
  .monitor-card{ padding:12px; border-radius:10px; background:#fff; border:1px solid #eef2f6; }
  .member-list label{ display:inline-flex; align-items:center; gap:8px; margin:6px 8px 6px 0; font-weight:600; }

  .slots { margin-top:10px; display:flex; flex-direction:column; gap:8px; }
  .slot-row{ display:flex; gap:10px; align-items:center; justify-content:space-between; }
  .slot-time{ min-width:160px; font-weight:700; color:#0f172a; }

  .output-box{ background:#f8fafb; padding:12px; border-radius:8px; border:1px solid #e6eef0; font-family:monospace; white-space:pre-wrap; min-height:140px; }

  footer { margin-top:12px; color:var(--muted); font-size:0.9rem; text-align:right; }

  /* presence */
  .presence-box { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:10px; padding:8px 10px; border-radius:8px; background:#f3f4f6; }
  .presence-header { color:var(--muted); font-weight:700; margin-right:8px; }
  .presence-item { display:inline-flex; gap:8px; align-items:center; padding:6px 8px; border-radius:6px; background:#fff; border:1px solid #eef2f6; font-weight:700; color:#0f172a; }
  .dot { width:10px; height:10px; border-radius:50%; background:#10b981; box-shadow:0 0 6px rgba(16,185,129,0.2); }

  @media (max-width:680px){
    .task-right{ width:100%; align-items:stretch; }
    .slot-time{ min-width:0; }
  }
</style>
</head>
<body>
  <div class="wrap">
    <header class="card" style="display:flex;align-items:center;">
      <div>
        <h1>IT Operations Task Manager</h1>
        <div class="sub">Realtime — all users can edit. Today's data auto-saved to Firebase.</div>
      </div>
      <div style="margin-left:auto">
        <button id="resetBtn" class="btn warn">Reset Today's Data</button>
      </div>
    </header>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-btn active" data-tab="daily">Daily</button>
      <button class="tab-btn" data-tab="weekly">Weekly</button>
      <button class="tab-btn" data-tab="monthly">Monthly</button>
      <button class="tab-btn" data-tab="patching">Patching</button>
      <button class="tab-btn" data-tab="monitoring">Monitoring</button>
      <button class="tab-btn" data-tab="output">Output</button>
    </div>

    <!-- DAILY -->
    <section id="daily" class="card tab-pane active">
      <!-- Presence area with Active users: count + list -->
      <div class="presence-box" id="presenceBox">
        <div class="presence-header" id="presenceHeader">Active users: 0</div>
        <div id="presenceList" style="display:flex;gap:8px;flex-wrap:wrap;"></div>
      </div>

      <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px;">
        <label style="font-weight:700;">Shift:</label>
        <select id="dailyShift">
          <option value="shift1">1st shift (06:30 - 14:30)</option>
          <option value="shift2">2nd shift (14:30 - 22:30)</option>
          <option value="shift3">3rd shift (22:30 - 06:30)</option>
        </select>
        <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
          <input id="addTaskInput" placeholder="Add new task name" style="padding:8px;border-radius:8px;border:1px solid #e6eef0;" />
          <button id="addTaskBtn" class="btn alt">Add Task</button>
        </div>
      </div>

      <div id="dailyTasks"></div>
    </section>

    <!-- WEEKLY -->
    <section id="weekly" class="card tab-pane" style="display:none;">
      <h3 style="margin:0 0 8px 0;">Weekly Tasks / Notes</h3>
      <textarea id="weeklyText" rows="6" placeholder="Type weekly tasks..."></textarea>
    </section>

    <!-- MONTHLY -->
    <section id="monthly" class="card tab-pane" style="display:none;">
      <h3 style="margin:0 0 8px 0;">Monthly Tasks / Notes</h3>
      <textarea id="monthlyText" rows="6" placeholder="Type monthly summary..."></textarea>
    </section>

    <!-- PATCHING -->
    <section id="patching" class="card tab-pane" style="display:none;">
      <h3 style="margin:0 0 8px 0;">Patching</h3>
      <textarea id="patchingText" rows="6" placeholder="Type patching tasks..."></textarea>
    </section>

    <!-- MONITORING -->
    <section id="monitoring" class="card tab-pane" style="display:none;">
      <h3 style="margin:0 0 10px 0;">Monitoring</h3>
      <div style="display:flex;gap:12px;align-items:center;">
        <label style="font-weight:700;">Shift:</label>
        <select id="monitorShift">
          <option value="shift1">1st shift (06:30 - 14:30)</option>
          <option value="shift2">2nd shift (14:30 - 22:30)</option>
          <option value="shift3">3rd shift (22:30 - 06:30)</option>
        </select>
        <div style="margin-left:auto; display:flex; gap:8px;">
          <button id="savePresentBtn" class="btn alt">Save Present Members</button>
          <button id="generateBtn" class="btn">Generate Slots</button>
          <button id="clearSlotsBtn" class="btn alt">Clear</button>
        </div>
      </div>

      <div class="monitor-grid" id="monitorGrid"></div>
    </section>

    <!-- OUTPUT -->
    <section id="output" class="card tab-pane" style="display:none;">
      <h3 style="margin:0 0 10px 0;">Generated Output (current shift)</h3>
      <div style="display:flex;gap:8px;align-items:center;">
        <button id="genOutputBtn" class="btn">Generate Output</button>
        <button id="copyBtn" class="btn alt">Copy</button>
        <button id="downloadBtn" class="btn alt">Download</button>
      </div>
      <div id="outputBox" class="output-box" style="margin-top:12px;"></div>
    </section>

    <footer>Prepared by Ian Romero - IT Operations</footer>
  </div>

  <!-- Firebase + logic -->
  <script type="module">
    /**************************************************************************
     * ITOPS Dashboard — Single file
     * - Realtime Firebase Realtime DB
     * - TRIGRAM presence (no auth) with Active users count
     * - Daily tasks per shift (default tasks + description)
     * - Monitoring: per-shift present members, Generate slots (divides shift), slot selection
     * - Free-text weekly/monthly/patching
     * - Output (current shift only) + Copy/Download
     * - Reset today's data
     *
     * Comments inline to help review.
     **************************************************************************/

    // Firebase v12 modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, get, remove, onDisconnect } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

    // === Firebase config (internal; provided) ===
    const firebaseConfig = {
      apiKey: "AIzaSyC56asNTd04xhDU4OlnBHS4zNxj_aiiFhM",
      authDomain: "activity-log-275ce.firebaseapp.com",
      databaseURL: "https://activity-log-275ce-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "activity-log-275ce",
      storageBucket: "activity-log-275ce.firebasedestorage.app",
      messagingSenderId: "436390670385",
      appId: "1:436390670385:web:a4e4bf77c32d4061c76510"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // ---------------- constants & paths ----------------
    const TODAY = new Date().toISOString().slice(0,10); // YYYY-MM-DD
    const ROOT = '/ITOPS_Dashboard';
    const TASKS_PATH = `${ROOT}/dailyTasks/${TODAY}`; // per-date tasks (shift -> tasks object)
    const MON_PATH = `${ROOT}/monitoring/${TODAY}`;   // per-date monitoring (shift -> { membersPresent: {}, slots: {} })
    const FREETEXT_PATH = `${ROOT}/freetext/${TODAY}`;

    // default members per shift (static lists as requested)
    const DEFAULT_MEMBERS = {
      shift1: ["IRO","FFA","JMA","NLA","MAG","RDE"],
	 //["PYC","CTR","CCR","LSU","HRO","DGU"], 
      shift2: ["DDI","CTR","HDE","MBA","ESO","AAS"],
	  //["IRO","JRU","JMA","NLA","MAG","RDE"],
      shift3: ["PYC","JRU","CCR","LSU","HRO","DGU"]
	  //["DDI","FFA","HDE","MBA","ESO","AAS"]
    };

    // default tasks per shift (preserve order)
    const DEFAULT_TASKS = {
      shift1: ["PW","ARC","Loglogic","TM1Top","ISMS","CRITICAL","PROXY","HO","Ticket Followup","TO"],
      shift2: ["PW","ARC","ISMS","Ticket Followup","TO"],
      shift3: ["PW","ARC","SC01 | SC02 Backup","SSRS Daily Report","Ticket Cleanup","Unknown Email Report","Ticket Followup","TO"]
    };

    // short hard-coded description placeholders (editable in the code)
    const DESC_PLACEHOLDER = {
      PW: "PREWORK to be sent before starting the shift",
      ARC: "Arcsight checks",
      Loglogic: "LogLogic checks",
      TM1Top: "TM1Top monitoring",
      ISMS: "ISMS server report",
      CRITICAL: "Critical services report",
      PROXY: "Proxy report",
      HO: "SPOC Handover",
      "Ticket Followup": "Follow up on open tickets. 1st shift: ASIA | 2nd shift: EMEA | 3rd shift: AMERICA",
      TO: "Turnover / notes"
    };

    // ---------------- UI refs ----------------
    const tabs = document.querySelectorAll('.tab-btn');
    const panes = document.querySelectorAll('.tab-pane');
    const dailyShift = document.getElementById('dailyShift');
    const dailyTasksEl = document.getElementById('dailyTasks');
    const addTaskInput = document.getElementById('addTaskInput');
    const addTaskBtn = document.getElementById('addTaskBtn');

    const weeklyText = document.getElementById('weeklyText');
    const monthlyText = document.getElementById('monthlyText');
    const patchingText = document.getElementById('patchingText');

    const monitorShift = document.getElementById('monitorShift');
    const monitorGrid = document.getElementById('monitorGrid');
    const generateBtn = document.getElementById('generateBtn');
    const savePresentBtn = document.getElementById('savePresentBtn');
    const clearSlotsBtn = document.getElementById('clearSlotsBtn');

    const genOutputBtn = document.getElementById('genOutputBtn');
    const outputBox = document.getElementById('outputBox');
    const copyBtn = document.getElementById('copyBtn');
    const downloadBtn = document.getElementById('downloadBtn');

    const resetBtn = document.getElementById('resetBtn');

    const presenceHeader = document.getElementById('presenceHeader');
    const presenceList = document.getElementById('presenceList');

    // Tab switching (UI only)
    tabs.forEach(t => t.addEventListener('click', () => {
      tabs.forEach(b => b.classList.remove('active'));
      panes.forEach(p => p.style.display = 'none');
      t.classList.add('active');
      document.getElementById(t.dataset.tab).style.display = 'block';
    }));

    // ---------------- helpers ----------------
    const safeKey = s => String(s).replace(/[.#$\[\]\/]/g,'_');
    function formatTimeFromMinutes(mins) {
      const h = Math.floor(mins / 60) % 24;
      const m = mins % 60;
      const ampm = h >= 12 ? 'PM' : 'AM';
      const hh = h % 12 === 0 ? 12 : h % 12;
      return `${hh}:${String(m).padStart(2,'0')} ${ampm}`;
    }

    // ---------------- PRESENCE (TRIGRAM) ----------------
    // Prompt once and persist to localStorage
    const PRESENCE_PATH = `${ROOT}/presence/${TODAY}`;
    let trigram = localStorage.getItem("itopsTrigram");
    if (!trigram) {
      const input = prompt("Enter your TRIGRAM (e.g. IRO, JMA, FFA):");
      trigram = (input || "ANON").toUpperCase().trim();
      localStorage.setItem("itopsTrigram", trigram);
    }
    // unique session key so duplicates appear separately if same trigram in two browsers
    const sessionId = "sess-" + Math.random().toString(36).slice(2,9);
    const myPresenceRef = ref(db, `${PRESENCE_PATH}/${sessionId}`);
    // write presence now and ensure removal on disconnect
    set(myPresenceRef, { name: trigram, ts: Date.now() });
    onDisconnect(myPresenceRef).remove();

    // Render presence list + Active users count
    function renderPresenceUI(snapshot) {
      const val = snapshot.exists() ? snapshot.val() : {};
      // compute set of active sessions & unique trigrams
      const sessions = Object.values(val || {});
      const uniqueNames = Array.from(new Set(sessions.map(s => s.name)));
      // header
      presenceHeader.textContent = `Active users: ${sessions.length} (${uniqueNames.length} unique)`;
      // list sessions
      presenceList.innerHTML = '';
      // show each session as presence-item (green dot + trigram)
      Object.entries(val || {}).forEach(([k,v]) => {
        const item = document.createElement('div');
        item.className = 'presence-item';
        item.innerHTML = `<span class="dot" aria-hidden></span><span>${v.name}</span>`;
        presenceList.appendChild(item);
      });
      if (sessions.length === 0) {
        presenceList.innerHTML = '<div style="color:var(--muted);font-weight:600;">No active users</div>';
      }
    }
    onValue(ref(db, PRESENCE_PATH), snap => renderPresenceUI(snap));

    // ---------------- Ensure DB defaults (only if missing) ----------------
    async function ensureDefaults() {
      // tasks skeleton
      const tasksSnap = await get(ref(db, TASKS_PATH));
      if (!tasksSnap.exists()) {
        const payload = {};
        Object.entries(DEFAULT_TASKS).forEach(([shift, arr])=>{
          payload[shift] = { tasks: {} };
          arr.forEach(t => payload[shift].tasks[safeKey(t)] = "");
        });
        await set(ref(db, TASKS_PATH), payload);
      }
      // monitoring skeleton
      const msnap = await get(ref(db, MON_PATH));
      if (!msnap.exists()) {
        const base = {};
        ['shift1','shift2','shift3'].forEach(s => base[s] = { membersPresent: {}, slots: {} });
        await set(ref(db, MON_PATH), base);
      }
      // freetext skeleton
      const fSnap = await get(ref(db, FREETEXT_PATH));
      if (!fSnap.exists()) {
        await set(ref(db, FREETEXT_PATH), { weekly:"", monthly:"", patching:"" });
      }
    }

    // ---------------- Render Daily Tasks ----------------
    // Each task card shows name, description (placeholder from code), and a select that lists only members of the selected shift.
    function renderDailyTasks(shiftKey) {
      dailyTasksEl.innerHTML = "";
      // use the DEFAULT_TASKS order; dynamic addition pushes into DEFAULT_TASKS in this session (non-persistent)
      const tasksList = DEFAULT_TASKS[shiftKey] || [];
      tasksList.forEach(taskName => {
        const row = document.createElement('div');
        row.className = 'task-card';
        const left = document.createElement('div'); left.className = 'task-left';
        const name = document.createElement('div'); name.className = 'task-name'; name.textContent = taskName;
        const desc = document.createElement('div'); desc.className = 'task-desc'; desc.textContent = DESC_PLACEHOLDER[taskName] || '';
        left.appendChild(name); left.appendChild(desc);

        const right = document.createElement('div'); right.className = 'task-right';
        const select = document.createElement('select');
        select.dataset.task = taskName;
        // placeholder "-Select-" and only members for the selected shift
        select.innerHTML = `<option value="">-Select-</option>` + (DEFAULT_MEMBERS[shiftKey] || []).map(m => `<option value="${m}">${m}</option>`).join('');
        right.appendChild(select);

        row.appendChild(left); row.appendChild(right);
        dailyTasksEl.appendChild(row);

        // realtime listener for this task's assignee (per-date)
        const taskRef = ref(db, `${TASKS_PATH}/${shiftKey}/tasks/${safeKey(taskName)}`);
        onValue(taskRef, snap => {
          const v = snap.exists() ? snap.val() : "";
          if ((select.value || '') !== (v || '')) select.value = v || '';
        });

        // when user picks assignee -> save to DB (realtime)
        select.addEventListener('change', () => {
          const val = select.value || "";
          set(ref(db, `${TASKS_PATH}/${shiftKey}/tasks/${safeKey(taskName)}`), val);
        });
      });
    }

    // Add new task manually (adds to DB and to local DEFAULT_TASKS list for immediate rendering)
    addTaskBtn.addEventListener('click', async () => {
      const name = (addTaskInput.value || '').trim();
      if (!name) return alert('Enter task name');
      const shiftKey = dailyShift.value || 'shift1';
      await set(ref(db, `${TASKS_PATH}/${shiftKey}/tasks/${safeKey(name)}`), "");
      if (!DEFAULT_TASKS[shiftKey].includes(name)) DEFAULT_TASKS[shiftKey].push(name);
      addTaskInput.value = '';
      renderDailyTasks(shiftKey);
    });

    // Listen to top-level TASKS_PATH to re-render when tasks are added/removed externally
    onValue(ref(db, TASKS_PATH), snap => {
      const shiftKey = dailyShift.value || 'shift1';
      renderDailyTasks(shiftKey);
    });

    // When shift changes, re-render tasks for that shift
    dailyShift.addEventListener('change', () => {
      const sk = dailyShift.value;
      renderDailyTasks(sk);
    });

    // ---------------- Free-text (Weekly/Monthly/Patching) binding ----------------
    function bindFreeText(key, el) {
      const r = ref(db, `${FREETEXT_PATH}/${key}`);
      onValue(r, snap => { const v = snap.exists() ? snap.val() : ""; if (el.value !== v) el.value = v; });
      el.addEventListener('input', () => set(ref(db, `${FREETEXT_PATH}/${key}`), el.value));
    }
    bindFreeText('weekly', weeklyText);
    bindFreeText('monthly', monthlyText);
    bindFreeText('patching', patchingText);

    // ---------------- Monitoring rendering & behaviour ----------------
    // Render all three shift cards (checkboxes for members + slots area)
    function renderMonitoring() {
      monitorGrid.innerHTML = '';
      ['shift1','shift2','shift3'].forEach(shiftKey => {
        const card = document.createElement('div'); card.className = 'monitor-card';
        const title = document.createElement('div'); title.innerHTML = `<strong>${shiftKey.toUpperCase()}</strong>`;
        card.appendChild(title);

        const memberList = document.createElement('div'); memberList.className = 'member-list'; memberList.style.marginTop='8px';
        (DEFAULT_MEMBERS[shiftKey] || []).forEach(m => {
          const label = document.createElement('label');
          label.innerHTML = `<input type="checkbox" data-member="${m}" data-shift="${shiftKey}"/> ${m}`;
          memberList.appendChild(label);
        });
        card.appendChild(memberList);

        // place for slots
        const slotsWrap = document.createElement('div'); slotsWrap.className = 'slots'; slotsWrap.id = `slots-${shiftKey}`;
        card.appendChild(slotsWrap);
        monitorGrid.appendChild(card);

        // Load present members from DB and check boxes accordingly
        const presentRef = ref(db, `${MON_PATH}/${shiftKey}/membersPresent`);
        onValue(presentRef, snap => {
          const present = snap.exists() ? snap.val() : {};
          memberList.querySelectorAll('input[type=checkbox]').forEach(cb => { cb.checked = !!present[cb.dataset.member]; });
        });

        // Watch slots for this shift and render them in slotsWrap
        const slotsRef = ref(db, `${MON_PATH}/${shiftKey}/slots`);
        onValue(slotsRef, snap => {
          const slots = snap.exists() ? snap.val() : {};
          // get present members to populate options
          get(ref(db, `${MON_PATH}/${shiftKey}/membersPresent`)).then(msnap => {
            const presentObj = msnap.exists() ? msnap.val() : {};
            const presentMembers = Object.keys(presentObj || {});
            slotsWrap.innerHTML = '';
            const entries = Object.entries(slots || {});
            // sort by stored startMin for deterministic order
            entries.sort((a,b) => (a[1].startMin||0) - (b[1].startMin||0));
            if (entries.length === 0) {
              slotsWrap.innerHTML = '<div style="color:var(--muted);font-size:0.9rem;">No slots yet. Tick members and click Generate Slots.</div>';
            } else {
              entries.forEach(([slotKey, sData]) => {
                const row = document.createElement('div'); row.className='slot-row';
                const timeDiv = document.createElement('div'); timeDiv.className='slot-time'; timeDiv.textContent = sData.label || slotKey;
                const sel = document.createElement('select'); sel.dataset.slot = slotKey;
                // default placeholder -Select- to avoid auto-assignment/locks
                sel.innerHTML = `<option value="">-Select-</option>` + presentMembers.map(m => `<option value="${m}">${m}</option>`).join('');
                sel.value = sData.member || '';
                sel.addEventListener('change', () => {
                  set(ref(db, `${MON_PATH}/${shiftKey}/slots/${slotKey}/member`), sel.value || '');
                });
                row.appendChild(timeDiv); row.appendChild(sel);
                slotsWrap.appendChild(row);
              });
            }
          });
        });
      });
    }

    // Save present members for currently selected monitorShift
    savePresentBtn.addEventListener('click', async () => {
      const shiftKey = monitorShift.value || 'shift1';
      const checked = Array.from(document.querySelectorAll(`input[type=checkbox][data-shift="${shiftKey}"]`)).filter(cb => cb.checked).map(cb => cb.dataset.member);
      const payload = {};
      checked.forEach(m => payload[m] = true);
      await set(ref(db, `${MON_PATH}/${shiftKey}/membersPresent`), payload);
      alert('Saved present members for ' + shiftKey);
    });

    // Generate slots: divides shift time evenly based on the number of checked members for the selected monitorShift
    generateBtn.addEventListener('click', async () => {
      const shiftKey = monitorShift.value || 'shift1';
      const checkedMembers = Array.from(document.querySelectorAll(`input[type=checkbox][data-shift="${shiftKey}"]`)).filter(cb => cb.checked).map(cb => cb.dataset.member);
      if (checkedMembers.length === 0) { alert('Select at least one member for this shift (tick checkboxes)'); return; }
      // persist membersPresent
      const mp = {}; checkedMembers.forEach(m => mp[m] = true);
      await set(ref(db, `${MON_PATH}/${shiftKey}/membersPresent`), mp);

      // shift times in minutes
      const shiftTimes = {
        shift1: {startMin: 6*60 + 30, endMin: 14*60 + 30}, // 06:30 - 14:30
        shift2: {startMin: 14*60 + 30, endMin: 22*60 + 30}, // 14:30 - 22:30
        shift3: {startMin: 22*60 + 30, endMin: (24*60) + (6*60 + 30)} // 22:30 - 06:30 next day
      };
      const st = shiftTimes[shiftKey].startMin;
      const en = shiftTimes[shiftKey].endMin;
      const totalMin = en - st;
      // divide evenly; last slot takes remainder
      const perSlot = Math.floor(totalMin / checkedMembers.length);
      const slotsObj = {};
      let cur = st;
      for (let i=0;i<checkedMembers.length;i++){
        const sMin = cur;
        const eMin = (i===checkedMembers.length-1) ? en : (cur + perSlot);
        const label = `${formatTimeFromMinutes(sMin)} - ${formatTimeFromMinutes(eMin)}`;
        const key = safeKey(label);
        slotsObj[key] = { label, member: "", startMin: sMin, endMin: eMin };
        cur = eMin;
      }
      await set(ref(db, `${MON_PATH}/${shiftKey}/slots`), slotsObj);
      alert('Slots generated for ' + shiftKey);
    });

    // Clear monitoring for selected shift
    clearSlotsBtn.addEventListener('click', async () => {
      const shiftKey = monitorShift.value || 'shift1';
      await set(ref(db, `${MON_PATH}/${shiftKey}`), { membersPresent: {}, slots: {} });
      alert('Cleared monitoring for ' + shiftKey);
    });

    // When monitorShift changed, re-render UI (slots and checkboxes are still driven by db listeners)
    monitorShift.addEventListener('change', () => {
      renderMonitoring();
    });

    // ---------------- FREETEXT live watchers ----------------
    onValue(ref(db, `${FREETEXT_PATH}/weekly`), snap => { weeklyText.value = snap.exists() ? snap.val() : ''; });
    onValue(ref(db, `${FREETEXT_PATH}/monthly`), snap => { monthlyText.value = snap.exists() ? snap.val() : ''; });
    onValue(ref(db, `${FREETEXT_PATH}/patching`), snap => { patchingText.value = snap.exists() ? snap.val() : ''; });

    weeklyText.addEventListener('input', () => set(ref(db, `${FREETEXT_PATH}/weekly`), weeklyText.value));
    monthlyText.addEventListener('input', () => set(ref(db, `${FREETEXT_PATH}/monthly`), monthlyText.value));
    patchingText.addEventListener('input', () => set(ref(db, `${FREETEXT_PATH}/patching`), patchingText.value));

    // ---------------- OUTPUT generation (current selected dailyShift only) ----------------
    genOutputBtn.addEventListener('click', async () => {
      const shiftKey = dailyShift.value || 'shift1';
      const now = new Date();
      const generated = now.toLocaleString();

      // daily tasks assignments
      const tasksSnap = await get(ref(db, `${TASKS_PATH}/${shiftKey}/tasks`));
      const tasks = tasksSnap.exists() ? tasksSnap.val() : {};

      // freetext
      const weeklySnap = await get(ref(db, `${FREETEXT_PATH}/weekly`));
      const monthlySnap = await get(ref(db, `${FREETEXT_PATH}/monthly`));
      const patchingSnap = await get(ref(db, `${FREETEXT_PATH}/patching`));

      // monitoring slots for shift
      const monSnap = await get(ref(db, `${MON_PATH}/${shiftKey}/slots`));
      const monitors = monSnap.exists() ? monSnap.val() : {};

      // build output
      let out = `IT OPERATIONS TASKS REPORT - ${shiftKey.toUpperCase()}\nDate: ${TODAY}\nGenerated: ${generated}\n\n`;
      out += `--- DAILY TASKS ---\n`;
      (DEFAULT_TASKS[shiftKey] || []).forEach(t => {
        const val = tasks[safeKey(t)] || '';
        out += `${t} — ${val || 'Unassigned'}\n`;
      });

      out += `\n--- WEEKLY ---\n${weeklySnap.exists() ? weeklySnap.val() : ''}\n\n`;
      out += `--- MONTHLY ---\n${monthlySnap.exists() ? monthlySnap.val() : ''}\n\n`;
      out += `--- PATCHING ---\n${patchingSnap.exists() ? patchingSnap.val() : ''}\n\n`;

      out += `--- MONITORING (${shiftKey}) ---\n`;
      const sortedSlots = Object.entries(monitors || {}).sort((a,b) => (a[1].startMin||0) - (b[1].startMin||0));
      sortedSlots.forEach(([k,v]) => {
        out += `${v.label} — ${v.member || 'Unassigned'}\n`;
      });

      // display and persist final output for today's shift
      outputBox.textContent = out;
      await set(ref(db, `${ROOT}/finalOutput/${TODAY}/${shiftKey}`), out);
    });

    // Copy & Download output
    copyBtn.addEventListener('click', async () => {
      const text = outputBox.textContent || '';
      if (!text) return alert('Generate output first');
      await navigator.clipboard.writeText(text);
      alert('Copied to clipboard');
    });
    downloadBtn.addEventListener('click', () => {
      const text = outputBox.textContent || '';
      if (!text) return alert('Generate output first');
      const blob = new Blob([text], { type: 'text/plain' });
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `itops-${TODAY}-${dailyShift.value||'shift'}.txt`; a.click();
    });

    // ---------------- Reset today's data ----------------
    resetBtn.addEventListener('click', async () => {
      if (!confirm('Reset ALL data for today? This will clear daily tasks assignments, freetexts, and monitoring for today.')) return;
      await remove(ref(db, TASKS_PATH));
      await remove(ref(db, MON_PATH));
      await remove(ref(db, FREETEXT_PATH));
      // re-init defaults and UI
      await ensureDefaults();
      renderDailyTasks(dailyShift.value || 'shift1');
      renderMonitoring();
      outputBox.textContent = '';
      alert('Today data reset');
    });

    // ---------------- Initialization ----------------
    (async function init(){
      // ensure database nodes exist for today (non-destructive)
      await ensureDefaults();
      // initial UI render
      renderDailyTasks(dailyShift.value || 'shift1');
      renderMonitoring();

      // populate freetext values (safety)
      const w = await get(ref(db, `${FREETEXT_PATH}/weekly`)); if (w.exists()) weeklyText.value = w.val();
      const m = await get(ref(db, `${FREETEXT_PATH}/monthly`)); if (m.exists()) monthlyText.value = m.val();
      const p = await get(ref(db, `${FREETEXT_PATH}/patching`)); if (p.exists()) patchingText.value = p.val();
    })();

  </script>
</body>
</html>
