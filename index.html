<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>IT Operations Task Manager (Realtime)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .tab-active { background-color:#2563eb; color:white; }
    .tab-inactive { background:#f3f4f6; color:#111827; }
    .locked { opacity: 0.6; }
    /* subtle style for monitoring selects */
    .slot-select { min-width: 11rem; }
    .slot-select option[disabled][value=""] { color: #6b7280; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen p-6 font-sans">
  <div class="max-w-6xl mx-auto bg-white rounded-xl shadow p-6">
    <header class="flex items-start gap-4 mb-6">
      <div>
        <h1 class="text-2xl font-bold">IT Operations Task Manager (Realtime)</h1>
        <div class="text-sm text-gray-600">Realtime collaboration — all users can edit. Locks are anonymous and auto-expire (2 minutes).</div>
      </div>
      <div class="ml-auto">
        <button id="resetBtn" class="bg-red-500 text-white px-3 py-2 rounded">Reset All (safe)</button>
      </div>
    </header>

    <!-- tabs -->
    <div class="flex gap-2 mb-4" id="tabs">
      <button id="tab-daily" class="px-4 py-2 rounded tab-active" onclick="showTab('daily')">Daily</button>
      <button id="tab-weekly" class="px-4 py-2 rounded tab-inactive" onclick="showTab('weekly')">Weekly</button>
      <button id="tab-monthly" class="px-4 py-2 rounded tab-inactive" onclick="showTab('monthly')">Monthly</button>
      <button id="tab-patching" class="px-4 py-2 rounded tab-inactive" onclick="showTab('patching')">Patching</button>
      <button id="tab-monitoring" class="px-4 py-2 rounded tab-inactive" onclick="showTab('monitoring')">Monitoring</button>
      <button id="tab-output" class="px-4 py-2 rounded tab-inactive" onclick="showTab('output')">Output</button>
    </div>

    <!-- DAILY -->
    <section id="daily" class="tab-content">
      <h2 class="text-lg font-semibold mb-3">Daily Tasks (per shift)</h2>

      <div class="flex items-center gap-3 mb-3">
        <label class="font-medium">Shift:</label>
        <select id="dailyShiftSelect" class="border rounded p-2">
          <option value="shift1">1st shift (06:30 - 14:30)</option>
          <option value="shift2">2nd shift (14:30 - 22:30)</option>
          <option value="shift3">3rd shift (22:30 - 06:30)</option>
        </select>

        <div class="ml-auto flex items-center gap-2">
          <label class="font-medium">Add Member:</label>
          <input id="newMemberKey" placeholder="TRI (e.g. IRO)" class="border p-2 rounded w-24" />
          <input id="newMemberName" placeholder="Full name" class="border p-2 rounded w-48" />
          <button id="btnAddMember" class="bg-green-600 text-white px-3 py-2 rounded">Add</button>
        </div>
      </div>

      <div id="dailyTasks" class="space-y-2 mb-3"></div>

      <div class="flex gap-2">
        <input id="newTask" class="flex-1 border rounded p-2" placeholder="Add new task (e.g. PW)" />
        <button id="btnAddTask" class="bg-green-500 text-white px-4 py-2 rounded">Add</button>
      </div>
    </section>

    <!-- WEEKLY -->
    <section id="weekly" class="tab-content hidden">
      <h2 class="text-lg font-semibold mb-2">Weekly Tasks (free-text)</h2>
      <textarea id="weeklyText" class="w-full border rounded p-3 h-40" placeholder="Type weekly tasks..."></textarea>
    </section>

    <!-- MONTHLY -->
    <section id="monthly" class="tab-content hidden">
      <h2 class="text-lg font-semibold mb-2">Monthly Tasks (free-text)</h2>
      <textarea id="monthlyText" class="w-full border rounded p-3 h-40" placeholder="Type monthly tasks..."></textarea>
    </section>

    <!-- PATCHING -->
    <section id="patching" class="tab-content hidden">
      <h2 class="text-lg font-semibold mb-2">Patching Tasks (free-text)</h2>
      <textarea id="patchingText" class="w-full border rounded p-3 h-40" placeholder="Type patching tasks..."></textarea>
    </section>

    <!-- MONITORING -->
    <section id="monitoring" class="tab-content hidden">
      <h2 class="text-lg font-semibold mb-3">Monitoring</h2>
      <div class="grid md:grid-cols-3 gap-4">
        <!-- shift1 -->
        <div class="border p-4 rounded">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold">1st Shift (06:30 - 14:30)</h3>
            <div>
              <button class="bg-blue-600 text-white px-2 py-1 rounded" onclick="generateShift('shift1')">Generate</button>
              <button class="ml-2 bg-gray-200 px-2 py-1 rounded" onclick="clearShift('shift1')">Clear</button>
            </div>
          </div>
          <div id="shift1-members" class="mt-3 space-y-1"></div>
          <div id="shift1-slots" class="mt-3 space-y-2"></div>
        </div>

        <!-- shift2 -->
        <div class="border p-4 rounded">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold">2nd Shift (14:30 - 22:30)</h3>
            <div>
              <button class="bg-blue-600 text-white px-2 py-1 rounded" onclick="generateShift('shift2')">Generate</button>
              <button class="ml-2 bg-gray-200 px-2 py-1 rounded" onclick="clearShift('shift2')">Clear</button>
            </div>
          </div>
          <div id="shift2-members" class="mt-3 space-y-1"></div>
          <div id="shift2-slots" class="mt-3 space-y-2"></div>
        </div>

        <!-- shift3 -->
        <div class="border p-4 rounded">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold">3rd Shift (22:30 - 06:30)</h3>
            <div>
              <button class="bg-blue-600 text-white px-2 py-1 rounded" onclick="generateShift('shift3')">Generate</button>
              <button class="ml-2 bg-gray-200 px-2 py-1 rounded" onclick="clearShift('shift3')">Clear</button>
            </div>
          </div>
          <div id="shift3-members" class="mt-3 space-y-1"></div>
          <div id="shift3-slots" class="mt-3 space-y-2"></div>
        </div>
      </div>
      <p class="text-sm text-gray-600 mt-3">Tick members (TRIGRAM) present for the shift, click <b>Generate</b> to create time slots (all start as “Select Member”). Choose assignees from the dropdowns; changes sync instantly. Slot locks apply only when a member is selected.</p>
    </section>

    <!-- OUTPUT -->
    <section id="output" class="tab-content hidden">
      <h2 class="text-lg font-semibold mb-3">Generated Output</h2>
      <div class="flex gap-2 mb-3">
        <button id="btnGenerateOutput" class="bg-indigo-600 text-white px-4 py-2 rounded">Generate Output (current shift only)</button>
        <button id="btnCopy" class="bg-gray-200 px-4 py-2 rounded">Copy</button>
        <button id="btnDownload" class="bg-gray-200 px-4 py-2 rounded">Download .txt</button>
      </div>
      <textarea id="finalOutput" class="w-full border rounded p-3 h-64"></textarea>
    </section>
  </div>

  <!-- Firebase + logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, remove, get, runTransaction } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    // === Firebase config (internal; no auth per your preference) ===
    const firebaseConfig = {
      apiKey: "AIzaSyC56asNTd04xhDU4OlnBHS4zNxj_aiiFhM",
      authDomain: "activity-log-275ce.firebaseapp.com",
      databaseURL: "https://activity-log-275ce-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "activity-log-275ce",
      storageBucket: "activity-log-275ce.firebasedestorage.app",
      messagingSenderId: "436390670385",
      appId: "1:436390670385:web:a4e4bf77c32d4061c76510"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // ---------- constants ----------
    const DEFAULT_MEMBERS = { IRO: "Ian Romero", RDE: "Rhizza De Guzman", FFA: "Felix Factor", NLA: "Nathan Lapena", MAG: "Michael Henry Aglubat", JMA: "Jelyn Malubay" };
    const DEFAULT_DAILY = {
      shift1: ["PW","ARC","Loglogic","TM1Top","ISMS","CRITICAL","PROXY","HO","EMEA","TO"],
      shift2: ["PW","ARC","ISMS","TO","EMEA"],
      shift3: ["PW","ARC","TICKET CLEANUP","SC01 SC02 BACKUP","EMEA","SSRS","UNK_EMAIL","TO"]
    };
    const LOCK_EXPIRY_MS = 2 * 60 * 1000; // 2 minutes
    const MAX_TEXT_LENGTH = 8000; // safety cap

    // ---------- helpers ----------
    const el = id => document.getElementById(id);
    const els = sel => Array.from(document.querySelectorAll(sel));
    function sanitizeInput(str) { return String(str ?? '').replace(/[<>]/g,'').trim().slice(0,200); }
    function sanitizeLongText(str) { return String(str ?? '').replace(/[<>]/g,'').slice(0, MAX_TEXT_LENGTH); }
    function safeKeyFromLabel(label) { return String(label).replace(/[.#$\[\]\/]/g,'_').slice(0,200); }

    // Tab switching
    window.showTab = function(tabName) {
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
      document.querySelectorAll('#tabs button').forEach(b => { b.classList.remove('tab-active'); b.classList.add('tab-inactive'); });
      const tabContent = el(tabName), tabButton = el(`tab-${tabName}`);
      if (tabContent) tabContent.classList.remove('hidden');
      if (tabButton) { tabButton.classList.remove('tab-inactive'); tabButton.classList.add('tab-active'); }
    };

    // anonymous client id for locks (session)
    let CLIENT_ID = sessionStorage.getItem('itops_client_id');
    if (!CLIENT_ID) {
      CLIENT_ID = 'anon-' + Math.random().toString(36).slice(2,9);
      sessionStorage.setItem('itops_client_id', CLIENT_ID);
    }

    // ---------- ensure defaults ----------
    async function ensureDefaults() {
      const tmSnap = await get(ref(db,'teamMembers'));
      if (!tmSnap.exists()) await set(ref(db,'teamMembers'), DEFAULT_MEMBERS);

      const dailySnap = await get(ref(db,'dailyTasks'));
      if (!dailySnap.exists()) {
        const payload = {};
        Object.entries(DEFAULT_DAILY).forEach(([shift, arr])=>{
          payload[shift] = {};
          arr.forEach(t => payload[shift][t] = { checked:false, member:"" });
        });
        await set(ref(db,'dailyTasks'), payload);
      }

      const msSnap = await get(ref(db,'monitoringSchedules'));
      if (!msSnap.exists()) {
        const base = {
          shift1: { start:"06:30", end:"14:30", members:{}, slots:{} },
          shift2: { start:"14:30", end:"22:30", members:{}, slots:{} },
          shift3: { start:"22:30", end:"06:30", members:{}, slots:{} }
        };
        await set(ref(db,'monitoringSchedules'), base);
      }

      if (!(await get(ref(db,'weekly'))).exists()) await set(ref(db,'weekly'), "");
      if (!(await get(ref(db,'monthly'))).exists()) await set(ref(db,'monthly'), "");
      if (!(await get(ref(db,'patching'))).exists()) await set(ref(db,'patching'), "");
      if (!(await get(ref(db,'finalOutput'))).exists()) await set(ref(db,'finalOutput'), "");
    }

    // ---------- teamMembers watcher ----------
    onValue(ref(db,'teamMembers'), snap => {
      const map = snap.exists() ? snap.val() : DEFAULT_MEMBERS;
      window._membersMap = map;
      ['shift1','shift2','shift3'].forEach(shiftId => {
        const container = el(shiftId + '-members');
        if (!container) return;
        container.innerHTML = '';
        Object.entries(map).forEach(([k,v]) => {
          const id = `${shiftId}-m-${k}`;
          const row = document.createElement('div');
          row.className = 'flex items-center gap-2';

          const cb = document.createElement('input');
          cb.type = 'checkbox'; cb.id = id; cb.dataset.key = k;

          const label = document.createElement('label');
          label.htmlFor = id; label.className = 'text-sm'; label.textContent = `${k} — ${v}`;

          row.appendChild(cb); row.appendChild(label);
          container.appendChild(row);
        });
      });

      // refresh options in existing selects
      els('select[data-slot]').forEach(sel => {
        const cur = sel.value || '';
        sel.innerHTML = '';
        const ph = document.createElement('option');
        ph.value = ''; ph.textContent = 'Select Member'; ph.disabled = true;
        sel.appendChild(ph);
        Object.entries(map).forEach(([k,v]) => {
          const o = document.createElement('option');
          o.value = k; o.textContent = `${k} (${v})`;
          sel.appendChild(o);
        });
        sel.value = cur;
      });
    });

    // add member
    el('btnAddMember').addEventListener('click', async () => {
      const key = sanitizeInput(el('newMemberKey').value).toUpperCase();
      const name = sanitizeInput(el('newMemberName').value);
      if (!key || !name) return alert('Enter trigram and full name');
      if (key.length > 6) return alert('Key too long');
      await set(ref(db, `teamMembers/${key}`), name);
      el('newMemberKey').value=''; el('newMemberName').value='';
    });

    // ---------- daily tasks ----------
    onValue(ref(db,'dailyTasks'), snap => {
      const data = snap.exists() ? snap.val() : {};
      const shift = el('dailyShiftSelect').value || 'shift1';
      renderDailyShift(shift, data[shift] || {});
    });

    el('dailyShiftSelect').addEventListener('change', async () => {
      const data = (await get(ref(db,'dailyTasks'))).val() || {};
      const shift = el('dailyShiftSelect').value;
      renderDailyShift(shift, data[shift] || {});
    });

    function renderDailyShift(shiftId, items) {
      const container = el('dailyTasks');
      if (!container) return;
      container.innerHTML = '';

      const tasks = items && typeof items === 'object' ? Object.keys(items) : (DEFAULT_DAILY[shiftId] || []);
      if (tasks.length === 0) {
        const tip = document.createElement('div');
        tip.className = 'text-gray-500';
        tip.textContent = 'No tasks found. Add tasks using the input below.';
        container.appendChild(tip);
        return;
      }

      tasks.forEach(task => {
        const taskData = (items && items[task]) || { checked:false, member:"" };
        const row = document.createElement('div'); row.className = 'flex items-center gap-3 py-2 border-b';

        const cb = document.createElement('input'); cb.type='checkbox'; cb.dataset.task=task; cb.checked=!!taskData.checked; cb.className='w-4 h-4';
        const mid = document.createElement('div'); mid.className='flex-1';
        const title = document.createElement('div'); title.className='font-medium'; title.textContent=task;
        mid.appendChild(title);

        const sel = document.createElement('select'); sel.dataset.task=task; sel.className='border rounded p-1 w-40';
        const memObj = window._membersMap || DEFAULT_MEMBERS;
        const ph = document.createElement('option'); ph.value=''; ph.textContent='-- Assign --'; ph.disabled=true;
        sel.appendChild(ph);
        Object.entries(memObj).forEach(([k,v])=>{
          const o = document.createElement('option'); o.value=k; o.textContent=`${k} (${v})`; sel.appendChild(o);
        });
        sel.value = taskData.member || '';

        const btn = document.createElement('button'); btn.dataset.remove=task; btn.className='ml-2 bg-red-500 text-white px-2 py-1 rounded text-sm'; btn.textContent='Remove';

        row.appendChild(cb); row.appendChild(mid); row.appendChild(sel); row.appendChild(btn);
        container.appendChild(row);

        cb.onchange = async () => {
          const shift = el('dailyShiftSelect').value || 'shift1';
          await set(ref(db, `dailyTasks/${shift}/${task}`), { checked: cb.checked, member: sel.value || "" });
        };
        sel.onchange = async () => {
          const shift = el('dailyShiftSelect').value || 'shift1';
          await set(ref(db, `dailyTasks/${shift}/${task}`), { checked: cb.checked || false, member: sel.value || "" });
        };
        btn.onclick = async () => {
          const shift = el('dailyShiftSelect').value || 'shift1';
          await remove(ref(db, `dailyTasks/${shift}/${task}`));
        };
      });
    }

    el('btnAddTask').addEventListener('click', async () => {
      const val = sanitizeInput(el('newTask').value);
      if (!val) return;
      const shift = el('dailyShiftSelect').value;
      await set(ref(db, `dailyTasks/${shift}/${val}`), { checked:false, member:"" });
      el('newTask').value = '';
    });

    // ---------- textareas ----------
    function watchText(key, elId) {
      onValue(ref(db, key), snap => {
        const v = snap.exists() ? snap.val() : '';
        const ta = el(elId);
        if (ta && ta.value !== v) ta.value = v;
      });
      el(elId).addEventListener('input', e => {
        const safe = sanitizeLongText(e.target.value);
        if (safe.length !== e.target.value.length) {
          alert('Text truncated to maximum allowed length.');
          e.target.value = safe;
        }
        set(ref(db, key), safe);
      });
    }
    watchText('weekly','weeklyText');
    watchText('monthly','monthlyText');
    watchText('patching','patchingText');

    // ---------- monitoring (shift-based) rendering & locks ----------
    async function renderShift(shiftId) {
      const snap = await get(ref(db, `monitoringSchedules/${shiftId}`));
      const shiftData = snap.exists() ? snap.val() : { start:(shiftId==='shift1'?'06:30':shiftId==='shift2'?'14:30':'22:30'), end:(shiftId==='shift1'?'14:30':shiftId==='shift2'?'22:30':'06:30'), members:{}, slots:{} };

      // member checkboxes
      els(`#${shiftId}-members input[type=checkbox]`).forEach(cb => {
        const key = cb.getAttribute('data-key');
        cb.checked = !!shiftData.members?.[key];
        cb.onchange = async () => {
          if (cb.checked) await set(ref(db, `monitoringSchedules/${shiftId}/members/${key}`), true);
          else await remove(ref(db, `monitoringSchedules/${shiftId}/members/${key}`));
        };
      });

      // render slots
      const slotsContainer = el(shiftId + '-slots');
      if (!slotsContainer) return;
      slotsContainer.innerHTML = '';
      const slots = shiftData.slots || {};

      const entries = Object.entries(slots).map(([k,v]) => [k,v]);
      entries.sort((a,b)=> (a[1]?.startTs||0) - (b[1]?.startTs||0) || (a[0] < b[0] ? -1 : 1));

      if (entries.length === 0) {
        const tip = document.createElement('div');
        tip.className = 'text-sm text-gray-500';
        tip.textContent = 'No slots yet. Click Generate to auto-divide (all slots start as “Select Member”).';
        slotsContainer.appendChild(tip);
        return;
      }

      entries.forEach(([slotKey, sData]) => {
        const displayLabel = sData.label || slotKey;
        const row = document.createElement('div'); row.className='flex gap-3 items-center py-1';
        const timeDiv = document.createElement('div'); timeDiv.className='w-56 text-sm'; timeDiv.textContent=displayLabel;

        const sel = document.createElement('select'); sel.dataset.slot=`${shiftId}|${slotKey}`; sel.className='border rounded p-1 slot-select';
        const lockInfoEl = document.createElement('div'); lockInfoEl.className='text-xs text-gray-500 ml-2'; lockInfoEl.dataset.lockinfo='';

        // options
        const memObj = window._membersMap || DEFAULT_MEMBERS;
        const ph = document.createElement('option'); ph.value=''; ph.textContent='Select Member'; ph.disabled=true; // placeholder
        sel.appendChild(ph);
        Object.entries(memObj).forEach(([k,v])=>{
          const o=document.createElement('option'); o.value=k; o.textContent=`${k} (${v})`; sel.appendChild(o);
        });
        sel.value = sData?.member || ''; // stays empty to show placeholder by default

        row.appendChild(timeDiv); row.appendChild(sel); row.appendChild(lockInfoEl);
        slotsContainer.appendChild(row);

        const slotRef = ref(db, `monitoringSchedules/${shiftId}/slots/${slotKey}`);

        // realtime lock/member sync
        onValue(slotRef, snap => {
          const val = snap.exists() ? snap.val() : {};
          const lockedBy = val.lockedBy || "";
          const lockTs = val.lockTs || 0;
          const now = Date.now();
          const expired = lockTs && (now - lockTs) > LOCK_EXPIRY_MS;

          if (lockedBy && !expired && lockedBy !== CLIENT_ID) {
            sel.disabled = true;
            row.classList.add('locked');
            const remaining = Math.max(0, Math.ceil((LOCK_EXPIRY_MS - (now-lockTs))/1000));
            lockInfoEl.textContent = `Locked (${remaining}s)`;
          } else {
            sel.disabled = false;
            row.classList.remove('locked');
            lockInfoEl.textContent = '';
          }

          const dbMember = val.member || '';
          if (sel.value !== dbMember) sel.value = dbMember; // keep in sync
        });

        // write only on valid member selection (prevents premature locks)
        sel.onchange = async () => {
          const chosen = sel.value || '';
          if (!chosen) return; // ignore placeholder
          const success = await tryAcquireLockTransactional(slotRef, chosen);
          if (!success) {
            alert('Slot is locked by another user. Try again later.');
            const cur = (await get(slotRef)).val() || {};
            sel.value = cur.member || '';
          }
        };
      });
    }

    async function tryAcquireLockTransactional(slotRef, memberKey) {
      try {
        const res = await runTransaction(slotRef, current => {
          const now = Date.now();
          if (!current) {
            return { member: memberKey || "", lockedBy: CLIENT_ID, lockTs: now, startTs: 0, label: "" };
          }
          const lockedBy = current.lockedBy || "";
          const lockTs = current.lockTs || 0;
          const expired = lockTs && (now - lockTs) > LOCK_EXPIRY_MS;
          if (!lockedBy || expired || lockedBy === CLIENT_ID) {
            current.member = memberKey || "";
            current.lockedBy = CLIENT_ID;
            current.lockTs = now;
            return current;
          }
          return; // abort
        });
        return !!(res && res.committed);
      } catch {
        return false;
      }
    }

    // watchers to re-render shifts
    onValue(ref(db,'monitoringSchedules/shift1'), () => renderShift('shift1'));
    onValue(ref(db,'monitoringSchedules/shift2'), () => renderShift('shift2'));
    onValue(ref(db,'monitoringSchedules/shift3'), () => renderShift('shift3'));

    // generate shift slots: now NO pre-assignment, all members default empty ("Select Member")
    function toDate(hm){ const [hh,mm]=hm.split(':').map(Number); const d=new Date(); d.setHours(hh,mm,0,0); return d; }
    function fmt(d){ let h=d.getHours(), m=d.getMinutes(), am=h>=12?'PM':'AM'; h=h%12||12; return `${String(h)}:${String(m).padStart(2,'0')} ${am}`; }

    window.generateShift = async function(shiftId) {
      const checked = els(`#${shiftId}-members input[type=checkbox]`).filter(cb=>cb.checked).map(cb=>cb.getAttribute('data-key'));
      if (!checked.length) return alert('Select at least one member for this shift.');
      const times = { shift1:{s:'06:30', e:'14:30'}, shift2:{s:'14:30', e:'22:30'}, shift3:{s:'22:30', e:'06:30'} };
      const {s,e} = times[shiftId];
      let start = toDate(s); let end = toDate(e);
      if (end <= start) end = new Date(end.getTime() + 24*60*60*1000);
      const totalMin = (end - start)/60000;
      const parts = checked.length; // number of slots equals number of present members
      const slotMin = totalMin/parts;
      let cur = new Date(start);

      const slotArray = [];
      for (let i=0;i<parts;i++){
        const sT = new Date(cur);
        cur.setMinutes(cur.getMinutes()+slotMin);
        const eT = new Date(cur);
        const label = `${fmt(sT)} - ${fmt(eT)}`;
        // NOTE: member starts empty => shows "Select Member"
        slotArray.push({ label, member: "", startTs: sT.getTime() });
      }

      slotArray.sort((a,b)=> a.startTs - b.startTs);

      const slots = {};
      slotArray.forEach(slot => {
        const key = safeKeyFromLabel(slot.label);
        slots[key] = { label: slot.label, member: "", lockedBy: "", lockTs: 0, startTs: slot.startTs };
      });

      const membersObj = {}; checked.forEach(k=>membersObj[k]=true);
      await set(ref(db, `monitoringSchedules/${shiftId}`), { start: s, end: e, members: membersObj, slots });
    };

    window.clearShift = async function(shiftId) {
      const times = { shift1:{s:'06:30', e:'14:30'}, shift2:{s:'14:30', e:'22:30'}, shift3:{s:'22:30', e:'06:30'} };
      await set(ref(db, `monitoringSchedules/${shiftId}`), { start: times[shiftId].s, end: times[shiftId].e, members: {}, slots: {} });
    };

    // ---------- Output (modified to include only current selected shift) ----------
    el('btnGenerateOutput').addEventListener('click', async () => {
      const selectedShift = el('dailyShiftSelect').value || 'shift1';
      // fetch only relevant nodes
      const dailySnap = await get(ref(db, `dailyTasks/${selectedShift}`));
      const monitoringSnap = await get(ref(db, `monitoringSchedules/${selectedShift}`));
      const weeklySnap = await get(ref(db, 'weekly'));
      const monthlySnap = await get(ref(db, 'monthly'));
      const patchingSnap = await get(ref(db, 'patching'));

      const daily = dailySnap.exists() ? dailySnap.val() : {};
      const monitoring = monitoringSnap.exists() ? monitoringSnap.val() : { start: '', end: '', slots: {} };

      let out = `IT OPERATIONS TASKS REPORT - ${selectedShift.toUpperCase()}\nGenerated: ${new Date().toLocaleString()}\n\n`;
      out += `--- DAILY TASKS (${selectedShift}) ---\n`;
      Object.entries(daily || {}).forEach(([t, info]) => {
        out += `${t} — ${info.member || 'Unassigned'} — ${info.checked ? 'Done' : 'Pending'}\n`;
      });

      out += `\n--- WEEKLY ---\n${weeklySnap.exists() ? weeklySnap.val() : ''}\n\n`;
      out += `--- MONTHLY ---\n${monthlySnap.exists() ? monthlySnap.val() : ''}\n\n`;
      out += `--- PATCHING ---\n${patchingSnap.exists() ? patchingSnap.val() : ''}\n\n`;

      out += `--- MONITORING (${selectedShift}) ---\n`;
      const slots = monitoring.slots || {};
      // iterate sorted by startTs
      const entries = Object.entries(slots).map(([k,v]) => [k, v]);
      entries.sort((a,b)=> (a[1]?.startTs||0) - (b[1]?.startTs||0) || (a[0] < b[0] ? -1 : 1));
      entries.forEach(([k, info]) => {
        out += `${info.label || k} — ${info.member || 'Unassigned'}\n`;
      });

      el('finalOutput').value = out;
      await set(ref(db,'finalOutput'), out);
    });

    el('btnCopy').addEventListener('click', async () => {
      const text = el('finalOutput').value;
      if (!text) return alert('Generate output first.');
      await navigator.clipboard.writeText(text);
      alert('Copied to clipboard');
    });

    el('btnDownload').addEventListener('click', () => {
      const text = el('finalOutput').value || '';
      const blob = new Blob([text], {type:'text/plain'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `itops-report-${el('dailyShiftSelect').value || 'shift'}-${new Date().toISOString().slice(0,10)}.txt`;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    onValue(ref(db,'finalOutput'), snap => { if (snap.exists()) el('finalOutput').value = snap.val(); });

    // ---------- Reset ----------
    el('resetBtn').addEventListener('click', async () => {
      if (!confirm('Reset ALL data to safe defaults? This will overwrite tasks, schedules, members and texts.')) return;
      const payload = {
        teamMembers: DEFAULT_MEMBERS,
        dailyTasks: (function(){
          const p = {};
          Object.entries(DEFAULT_DAILY).forEach(([shift,arr])=>{
            p[shift] = {};
            arr.forEach(t => p[shift][t] = { checked:false, member:"" });
          });
          return p;
        })(),
        monitoringSchedules: {
          shift1: { start:"06:30", end:"14:30", members:{}, slots:{} },
          shift2: { start:"14:30", end:"22:30", members:{}, slots:{} },
          shift3: { start:"22:30", end:"06:30", members:{}, slots:{} }
        },
        weekly: "",
        monthly: "",
        patching: "",
        finalOutput: ""
      };
      await set(ref(db), payload);
      alert('Reset complete and defaults restored.');
    });

    // ---------- init ----------
    (async function init(){
      await ensureDefaults();
      showTab('daily');
      renderShift('shift1');
      renderShift('shift2');
      renderShift('shift3');
    })();
  </script>
</body>
</html>
